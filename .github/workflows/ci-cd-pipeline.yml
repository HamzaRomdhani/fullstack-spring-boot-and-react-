name: CI/CD Pipeline (Artifact-Persisted)

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  # ---------------------------------------------------------
  # JOB 1: Build & Push Docker Images
  # ---------------------------------------------------------
  build-and-push:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '11'
          cache: 'maven'

      # Build & Generate Coverage
      # We use 'verify' to generate JaCoCo XML. We rely on H2 profile defined in properties.
      # We DO NOT use 'clean' here, we want to keep the folder for artifact upload.
      - name: Build & Test (Maven) - Generate JaCoCo XML
        working-directory: ./spring-backend
        run: mvn -B verify -Dspring.datasource.url="jdbc:h2:mem:testdb;MODE=PostgreSQL" -Dspring.datasource.driver-class-name=org.h2.Driver -Dspring.jpa.database-platform=org.hibernate.dialect.H2Dialect

      # CRITICAL STEP: Persist Maven Target Folder
      # We zip and upload the target folder so the next job can access it.
      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: maven-target
          path: spring-backend/target
          retention-days: 1

      # --- Backend Build ---
      - name: Build and push Backend
        uses: docker/build-push-action@v5
        with:
          context: ./spring-backend
          file: ./spring-backend/Dockerfile
          push: true
          tags: |
            hamzaromdhani/hobbie-backend:latest
            hamzaromdhani/hobbie-backend:${{ github.sha }}

      # --- Frontend Build ---
      - name: Build and push Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./react-frontend
          file: ./react-frontend/Dockerfile
          push: true
          tags: |
            hamzaromdhani/hobbie-frontend:latest
            hamzaromdhani/hobbie-frontend:${{ github.sha }}

  # ---------------------------------------------------------
  # JOB 2: SonarCloud Analysis
  # ---------------------------------------------------------
  sonar-analysis:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Build Artifacts
        # Restore the target folder from the previous job
        uses: actions/download-artifact@v4
        with:
          name: maven-target
          path: spring-backend/target

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '11'
          cache: 'maven'

      # Run Sonar Scan on the downloaded artifacts
      - name: Analyze with SonarCloud
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.HUBGIT_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=HamzaRomdhani_fullstack-spring-boot-and-react
            -Dsonar.organization=hamzaromdhani
            -Dsonar.host.url=https://sonarcloud.io
            # Explicit properties to ensure analysis works
            -Dsonar.sources=spring-backend/src/main/java,react-frontend/src
            -Dsonar.tests=spring-backend/src/test/java
            -Dsonar.java.binaries=spring-backend/target/classes
            -Dsonar.coverage.jacoco.xmlReportPaths=spring-backend/target/site/jacoco/jacoco.xml
            -Dsonar.exclusions=**/target/**,**/node_modules/**,**/*.spec.js

  # ---------------------------------------------------------
  # JOB 3: Deploy to Minikube
  # ---------------------------------------------------------
  deploy-minikube:
    name: Deploy to Minikube
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create K8s Directory and Manifests
        run: |
          mkdir -p k8s
          
          # Create 00-namespace.yaml
          cat <<EOF > k8s/00-namespace.yaml
          apiVersion: v1
          kind: Namespace
          metadata:
            name: hobbies-app
          EOF
          
          # Create 01-secrets.yaml
          cat <<EOF > k8s/01-secrets.yaml
          apiVersion: v1
          kind: Secret
          metadata:
            name: hobbies-secret
            namespace: hobbies-app
          type: Opaque
          stringData:
            DB_PASSWORD: "postgres"
            JWT_SECRET: "your-jwt-secret-here"
            MAIL_PASSWORD: "your-mail-password-here"
            CLOUDINARY_API_SECRET: "your-cloudinary-secret"
            CLOUDINARY_API_KEY: "your-cloudinary-key"
          EOF
          
          # Create 02-postgres.yaml
          cat <<EOF > k8s/02-postgres.yaml
          apiVersion: apps/v1
          kind: StatefulSet
          metadata:
            name: db
            namespace: actions-app
          spec:
            serviceName: db
            replicas: 1
            selector:
              matchLabels:
                app: db
            template:
              metadata:
                labels:
                  app: db
              spec:
                containers:
                  - name: postgres
                    image: postgres:15
                    ports:
                      - containerPort: 5432
                    env:
                      - name: POSTGRES_DB
                        value: "hobbie_backend_db"
                      - name: POSTGRES_USER
                        value: "postgres"
                      - name: POSTGRES_PASSWORD
                        valueFrom:
                          secretKeyRef:
                            name: hobbies-secret
                            key: DB_PASSWORD
                    volumeMounts:
                      - name: postgres-storage
                        mountPath: /var/lib/postgresql/data
                volumeClaimTemplates:
                  - metadata:
                      name: postgres-storage
                  spec:
                    accessModes:
                      - ReadWriteOnce
                    resources:
                      requests:
                        storage: 1Gi
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: db
            namespace: hobbies-app
          spec:
            ports:
              - port: 5432
            selector:
              app: db
            clusterIP: None
          EOF

          # Create 03-backend.yaml
          cat <<EOF > k8s/03-backend.yaml
          apiVersion: apps/v1
          kind: ConfigMap
          metadata:
            name: backend-config
            namespace: hobbies-app
          data:
            SPRING_DATASOURCE_URL: "jdbc:postgresql://db.hobbies-app.svc.cluster.local:5432/hobbie_backend_db"
            SPRING_DATASOURCE_USERNAME: "postgres"
            SPRING_DATASOURCE_PASSWORD: "postgres"
            SPRING_JPA_HIBERNATE_DDL_AUTO: "update"
          ---
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: backend
            namespace: hobbies-app
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: backend
            template:
              metadata:
                labels:
                  app: backend
              spec:
                containers:
                  - name: backend
                    image: hamzaromdhani/hobbie-backend:latest
                    imagePullPolicy: Always
                    ports:
                      - containerPort: 8080
                    envFrom:
                      - configMapRef:
                          name: backend-config
                      - secretRef:
                          name: hobbies-secret
                          optional: false
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: backend
            namespace: hobbies-app
          spec:
            ports:
              - port: 8080
            targetPort: 8080
            selector:
              app: backend
            clusterIP: None
          EOF

          # Create 04-frontend.yaml
          cat <<EOF > k8s/04-frontend.yaml
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: frontend
            namespace: hobbies-app
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: frontend
            template:
              metadata:
                labels:
                  app: frontend
              spec:
                containers:
                  - name: frontend
                    image: hamzaromdhani/hobbie-frontend:latest
                    imagePullPolicy: Always
                    ports:
                      - containerPort: 80
                    env:
                      - name: VITE_API_URL
                        value: "http://backend.hobbies-app.svc.cluster.local:8080"
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: frontend
            namespace: hobbies-app
          spec:
            ports:
              - port: 80
            targetPort: 80
            selector:
              app: frontend
            clusterIP: None
          EOF

          # Create 05-ingress.yaml
          cat <<EOF > k8s/05-ingress.yaml
          apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            name: hobbies-ingress
            namespace: hobbies-app
          annotations:
            nginx.ingress.kubernetes.io/rewrite-target: /
          spec:
            rules:
              - host: hobbies.local
                http:
                  paths:
                    - path: /api
                      pathType: Prefix
                      backend:
                          service:
                            name: backend
                            port:
                              number: 8080
                    - path: /
                      pathType: Prefix
                      backend:
                          service:
                            name: frontend
                            port:
                              number: 80
          EOF

      - name: Install Minikube & Kubectl
        run: |
          curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
          sudo install minikube-linux-amd64 /usr/local/bin/minikube
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/
          sudo usermod -aG docker $USER

      - name: Start Minikube
        run: |
          # Use driver=none for GitHub Actions
          minikube start --driver=none
          
          # Enable Ingress
          minikube addons enable ingress

      - name: Deploy to K8s
        run: |
          # Wait for nodes to be ready
          kubectl wait --for=condition=ready node --timeout=120s
          
          # Apply manifests
          kubectl apply -f k8s/

      - name: Get Access Info
        run: |
          echo "------------------------------------------"
          echo "Deployment Complete!"
          echo "To access your application, run this command in a new terminal:"
          echo "  minikube tunnel"
          echo "------------------------------------------"