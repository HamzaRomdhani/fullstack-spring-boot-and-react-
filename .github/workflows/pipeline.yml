name: CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  # Job 1: SonarCloud Analysis
  sonar-analysis:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Important for Sonar history

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '11'
          cache: 'maven'

      - name: Build & Test (Maven) - Generate JaCoCo
        working-directory: ./spring-backend
        # We force H2 via command line arguments as discussed
        run: mvn -B clean verify -Dspring.datasource.url="jdbc:h2:mem:testdb;MODE=PostgreSQL" -Dspring.datasource.driver-class-name=org.h2.Driver -Dspring.jpa.database-platform=org.hibernate.dialect.H2Dialect

      - name: Analyze with SonarCloud
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.HUBGIT_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        # We don't need args here because we moved sonar-project.properties into spring-backend folder
        # so mvn will pick it up automatically.

  # Job 2: Docker Build & Push
  docker-build:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # --- Backend Build ---
      - name: Build and push Backend
        uses: docker/build-push-action@v5
        with:
          context: ./spring-backend
          file: ./spring-backend/Dockerfile
          push: true
          tags: |
            hamzaromdhani/hobbie-backend:latest
            hamzaromdhani/hobbie-backend:${{ github.sha }}

      # --- Frontend Build ---
      - name: Build and push Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./react-frontend
          file: ./react-frontend/Dockerfile
          push: true
          tags: |
            hamzaromdhani/hobbie-frontend:latest
            hamzaromdhani/hobbie-frontend:${{ github.sha }}